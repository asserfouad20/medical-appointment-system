<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - Medical Appointment System</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <header class="header">
        <nav class="nav">
            <a href="#" class="logo">MediCare</a>
            <ul class="nav-links">
                <li><a href="patient-dashboard.html">Dashboard</a></li>
                <li><a href="doctor-list.html">Find Doctors</a></li>
                <li><a href="my-appointments.html">My Appointments</a></li>
                <li><a href="appointment-history.html">History</a></li>
                <li><a href="patient-profile.html">Profile</a></li>
                <li><a href="settings.html">Settings</a></li>
                <li><a href="#" id="logoutBtn">Logout</a></li>
            </ul>
        </nav>
    </header>

    <div class="container-small">
        <div class="dashboard-header">
            <h1 class="dashboard-title">My Profile</h1>
            <p class="dashboard-subtitle">Manage your personal information</p>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Personal Information</h2>
            </div>
            <div class="card-body">
                <form id="profileForm">
                    <div class="form-group">
                        <label class="form-label" for="name">Full Name</label>
                        <input type="text" id="name" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="email">Email</label>
                        <input type="email" id="email" class="form-control" disabled>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="phone">Phone Number</label>
                        <input type="tel" id="phone" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Gender</label>
                        <div class="form-radio-group">
                            <label class="form-radio-label">
                                <input type="radio" name="gender" value="male"> Male
                            </label>
                            <label class="form-radio-label">
                                <input type="radio" name="gender" value="female"> Female
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="dob">Date of Birth</label>
                        <input type="date" id="dob" class="form-control" required>
                    </div>

                    <button type="submit" class="btn btn-primary btn-block">Update Profile</button>
                </form>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h2 class="card-title">Change Password</h2>
            </div>
            <div class="card-body">
                <form id="passwordForm">
                    <div class="form-group">
                        <label class="form-label" for="currentPassword">Current Password</label>
                        <input type="password" id="currentPassword" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="newPassword">New Password</label>
                        <input type="password" id="newPassword" class="form-control" required minlength="6">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="confirmNewPassword">Confirm New Password</label>
                        <input type="password" id="confirmNewPassword" class="form-control" required>
                    </div>

                    <button type="submit" class="btn btn-primary btn-block">Change Password</button>
                </form>
            </div>
        </div>
    </div>

    <script src="../js/app.js"></script>
    <script>
        // Load data from localStorage first
        utils.loadData();

        // Check authentication
        if (!utils.requireAuth('patient')) {
            window.location.href = '../index.html';
        }

        const currentUser = utils.getCurrentUser();

        // Populate form with current data
        document.getElementById('name').value = currentUser.name;
        document.getElementById('email').value = currentUser.email;
        document.getElementById('phone').value = currentUser.phone;
        document.getElementById('dob').value = currentUser.dob;
        document.querySelector(`input[name="gender"][value="${currentUser.gender}"]`).checked = true;

        // Handle profile update
        document.getElementById('profileForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const updatedData = {
                name: document.getElementById('name').value,
                phone: document.getElementById('phone').value,
                gender: document.querySelector('input[name="gender"]:checked').value,
                dob: document.getElementById('dob').value
            };

            if (utils.updatePatient(currentUser.id, updatedData)) {
                // Update current user session
                Object.assign(currentUser, updatedData);
                utils.setCurrentUser(currentUser);
                showToast('Profile updated successfully!', 'success');
            }
        });

        // Handle password change
        document.getElementById('passwordForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;

            if (currentPassword !== currentUser.password) {
                showToast('Current password is incorrect!', 'error');
                return;
            }

            if (newPassword !== confirmNewPassword) {
                showToast('New passwords do not match!', 'error');
                return;
            }

            if (utils.updatePatient(currentUser.id, { password: newPassword })) {
                currentUser.password = newPassword;
                utils.setCurrentUser(currentUser);
                showToast('Password changed successfully!', 'success');
                document.getElementById('passwordForm').reset();
            }
        });

        const dobInput = document.getElementById('dob');
        const today = new Date().toISOString().split('T')[0];
        dobInput.setAttribute('max', today);

        document.getElementById('logoutBtn').addEventListener('click', (e) => {
            e.preventDefault();
            utils.logout();
        });
    </script>
</body>
</html>
